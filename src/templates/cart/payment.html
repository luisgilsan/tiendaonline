{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<style>
    
    .lds-hourglass {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }
      .lds-hourglass:after {
        content: " ";
        display: block;
        border-radius: 50%;
        width: 0;
        height: 0;
        margin: 8px;
        box-sizing: border-box;
        border: 32px solid rgb(146, 35, 35);
        border-color: #fff transparent #fff transparent;
        animation: lds-hourglass 1.2s infinite;
      }
      @keyframes lds-hourglass {
        0% {
          transform: rotate(0);
          animation-timing-function: cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }
        50% {
          transform: rotate(900deg);
          animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
        }
        100% {
          transform: rotate(1800deg);
        }
      }      
</style>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <form method="POST" action="https://sandbox.checkout.payulatam.com/ppp-web-gateway-payu" class="text-center">
                {% csrf_token %}
                <div class="p-2 p-lg-2">
                    {{ form|crispy}}
                </div>
                <div class="row text-center">
                    <div class="form-group text-center">
                        <input type="image" name="submit" src="https://ecommerce.payulatam.com/img-secure-2015/boton_pagar_grande.png" border="0" alt="Submit" style="width: 250px;" />
                    </div>
                </div>
            </form>

            <div class="alert alert-success" role="alert" id="alertSuccess" style="display: none;">
                Tu pago fue exitoso.
            </div>
            <div class="alert alert-danger" role="alert" id="alertFaileru" style="display: none;">
                Tu pago ha fallado, intenta de nuevo.
            </div>


            <div class="text-center py-3">
                <div id="loader" class="lds-hourglass" style="margin: auto; display:none;"></div>
            </div>
            <!-- 
            {# 
                <div id="paymentInfo">
                    <p>El total del pedido: ${{ order.get_total }}</p>
                    <h4>Seleccione un metodo de pago</h4>
                </div>
                <div class="container text-center py-3">
                    <img src="{% static 'images/botonpayu.png' %}" style="max-width: 300px;" alt="Snow"/>
                    <button class="btn">Pagar</button>
                </div>
                <div id="paypal-button-container">
                </div>
            #}
             -->
        </div>
        
    </div>
</div>


{% endblock content %}


{% block scripts %}
    <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}">
    </script>
    <script>

        const loader = document.getElementById('loader');
        const paymentInfo = document.getElementById('paymentInfo');

        function toggleLoader(on){
            loader.style.display = on === true ? "block" : "none";
            paymentInfo.style.display = on === true ? "none" : "block";
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function sendOrderConfirmed() {
            return fetch("{% url 'cart:confirm-order' %}", {
                method: "post",
                body: JSON.stringify(details),
                headers: {
                    "Content-Type" : "application/json",
                    "X-CSRFToken" : csrftoken
                }
            })
        }

        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: '{{ order.get_total }}'
                        }
                    }]
                });
            },
            onApprove: function(data, actions) {
                toggleLoader(true);
                return actions.order.capture().then(function(details) {
                    sendOrderConfirmed(details).then(res => {
                        toggleLoader(false);
                        const alertSuccess = document.getElementById('alertSuccess');
                        alertSuccess.style.display = "block";
                        setTimeout(function(){
                            window.location.replace('{{ CALLBACK_URL }}')
                        },3000);
                    })
                })
                    .catch(err => {
                    const alertFaileru = document.getElementById('alertFaileru');
                    alertSuccess.style.display = "block";
                    })
                    .finally(() => toggleLoader(false));
            }
        }).render('#paypal-button-container')
    </script>
{% endblock scripts %}
